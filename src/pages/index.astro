---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import heroImage from '../assets/hero-image.png';
// Phosphor Icons for Amazon placeholders
import { DeviceMobile, Book, TShirt, House, Tree, CookingPot, PuzzlePiece, Lipstick, SoccerBall, PawPrint, Baby, Car, Briefcase, MusicNote, Heartbeat, ShoppingBag } from 'phosphor-icons';

const blogPosts = await getCollection('blog');
const giftGuides = await getCollection('gift-guides');

// Combine and sort all content by date
const allContent = [
	...blogPosts.map(post => ({ ...post, type: 'blog' })),
	...giftGuides.map(guide => ({ ...guide, type: 'gift-guide' }))
].sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
---

<Layout 
	title="AI Gift Idea Generator | Find the Perfect Gift in Seconds"
	description="Find the perfect gift in seconds with our AI-powered gift idea generator. Personalized recommendations for any recipient, budget, and occasion. Try our free gift finder today!"
	image="/images/bright-gift-og-default.jpg"
	keywords={["gift ideas", "AI gifts", "personalized gifts", "gift finder", "gift recommendations", "birthday gifts", "holiday gifts"]}
	canonical="https://bright-gift.com"
	ogType="website"
	twitterCard="summary_large_image"
>
	<main class="font-sans text-gray-800 dark:text-gray-200">
		<!-- Hero Section -->
		<section class="relative w-full bg-[#FEF2D3] shadow-lg border-t-8 border-[#FF6B6B] mt-0 mx-auto px-4 py-8 md:py-12 flex flex-col md:flex-row items-center justify-center min-h-[350px]">
			<div class="absolute top-0 right-0 mt-6 mr-10 flex gap-8 font-semibold text-[#1C2E4A] text-lg z-10">
				<a href="/" class="hover:underline underline-offset-4 rounded">Home</a>
				<a href="/blog" class="hover:underline underline-offset-4 rounded">Blog</a>
				<a href="#about-tool" class="hover:underline underline-offset-4 rounded">About</a>
			</div>
			<div class="flex-1 flex flex-col items-center md:items-start justify-center text-center md:text-left">
				<img src="/bright-gift-logo.png" alt="BrightGift logo" class="h-20 md:h-24 mb-4" />
				<h1 class="text-3xl md:text-4xl font-bold font-poppins text-[#1C2E4A] mb-2">Let's Find Something Fun!</h1>
				<p class="text-lg font-inter text-[#333] mb-4">Surprise them in style â€“ let's get gifting!</p>
			</div>
			<div class="flex-1 flex items-center justify-center relative mt-6 md:mt-0">
				<img src="/hero-image.png" alt="Fun gift items: plant book, dino mug, taco plush" class="max-h-60 md:max-h-[412px] w-auto mx-auto" />
			</div>
		</section>

		<!-- Tool Section -->
		<section id="tool" class="py-20 px-4">
			<div class="max-w-2xl mx-auto bg-[#A3E4DB] p-10 rounded-2xl shadow-lg">
				<h2 class="text-3xl font-bold text-center mb-8 font-poppins text-[#1C2E4A]">Gift Finder</h2>
				<form aria-label="Gift Finder Form">
					<!-- Recipient Info -->
					<div class="mb-4">
						<label for="recipient" class="block font-bold mb-2 text-[#1C2E4A]">Who are you shopping for?</label>
						<input type="text" id="recipient" name="recipient" aria-required="true" class="w-full px-4 py-3 border-2 border-[#A3E4DB] rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-[#FFDE59] text-[#1C2E4A]" placeholder="e.g., my 30-year-old brother">
					</div>

					<!-- Interests -->
					<div class="mb-4">
						<label for="interests" class="block font-bold mb-2 text-[#1C2E4A]">What do they like?</label>
						<input type="text" id="interests" name="interests" aria-required="true" class="w-full px-4 py-3 border-2 border-[#A3E4DB] rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-[#FFDE59] text-[#1C2E4A]" placeholder="e.g., hiking, sci-fi movies, craft beer">
					</div>

					<!-- Budget -->
					<div class="mb-4">
						<label for="budget" class="block font-bold mb-2 text-[#1C2E4A]">What's your budget?</label>
						<select id="budget" name="budget" aria-required="true" class="w-full px-4 py-3 border-2 border-[#A3E4DB] rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-[#FFDE59] text-[#1C2E4A] text-gray-400">
							<option value="25">Under $25</option>
							<option value="50" selected>Under $50</option>
							<option value="100">Under $100</option>
							<option value="200">Under $200</option>
						</select>
					</div>

					<!-- Style Selector as Chips -->
					<div class="mb-6">
						<label class="block font-bold mb-2 text-[#1C2E4A]">What's the style?</label>
						<div class="flex flex-wrap gap-2" role="radiogroup" aria-label="Gift Style">
							<button type="button" role="radio" aria-checked="false" tabindex="0" class="bg-[#FFDE59] text-[#1C2E4A] px-4 py-2 rounded-full text-sm font-semibold hover:bg-[#FFF9F3] transition">ğŸŒ± Eco-Friendly</button>
							<button type="button" role="radio" aria-checked="false" tabindex="-1" class="bg-[#A3E4DB] text-[#1C2E4A] px-4 py-2 rounded-full text-sm font-semibold hover:bg-[#FFF9F3] transition">ğŸ–ï¸ Handmade</button>
							<button type="button" role="radio" aria-checked="false" tabindex="-1" class="bg-[#FF6B6B] text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-[#ff4c4c] transition">ğŸ‰ Funny</button>
							<button type="button" role="radio" aria-checked="false" tabindex="-1" class="bg-[#FFDE59] text-[#1C2E4A] px-4 py-2 rounded-full text-sm font-semibold hover:bg-[#FFF9F3] transition">ğŸŒˆ LGBTQ+ Owned</button>
							<button type="button" role="radio" aria-checked="false" tabindex="-1" class="bg-[#A3E4DB] text-[#1C2E4A] px-4 py-2 rounded-full text-sm font-semibold hover:bg-[#FFF9F3] transition">ğŸ’¡ Quirky</button>
							<button type="button" role="radio" aria-checked="false" tabindex="-1" class="bg-[#FF6B6B] text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-[#ff4c4c] transition">ğŸ’ Luxury</button>
							<button type="button" role="radio" aria-checked="false" tabindex="-1" class="bg-[#FFDE59] text-[#1C2E4A] px-4 py-2 rounded-full text-sm font-semibold hover:bg-[#FFF9F3] transition">ğŸ“š Techy</button>
							<button type="button" role="radio" aria-checked="false" tabindex="-1" class="bg-[#A3E4DB] text-[#1C2E4A] px-4 py-2 rounded-full text-sm font-semibold hover:bg-[#FFF9F3] transition">ğŸ§‘â€ğŸ¤â€ğŸ§‘ BIPOC Owned</button>
						</div>
					</div>

					<!-- Submit Button -->
					<div class="text-center">
						<button type="submit" class="w-full bg-[#FF6B6B] text-white font-bold py-3 px-8 rounded-full hover:bg-[#ff4c4c] transition-colors font-poppins text-lg shadow">
							Generate Gift Ideas
						</button>
					</div>
				</form>
			</div>
		</section>

		<!-- Results Section -->
		<section id="results" class="py-20 px-4">
			<div class="max-w-4xl mx-auto">
				<h2 class="text-3xl font-bold text-center mb-12 text-[#1C2E4A]">Your Gift Ideas</h2>
				<!-- Loading state placeholder -->
				<div id="loading" class="text-center hidden">
					<div class="flex flex-col items-center justify-center gap-2">
						<svg class="animate-spin h-11 w-11" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
							<circle class="opacity-100" cx="12" cy="12" r="10" stroke="#A3E4DB" stroke-width="4"></circle>
							<path class="opacity-100" fill="#FF6B6B" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
						</svg>
						<span class="text-[#1C2E4A] font-semibold">Generating ideas...</span>
					</div>
				</div>
				<!-- Results will be injected here -->
				<div id="results-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" role="list" aria-live="polite">
					<p id="empty-state" class="text-center text-gray-400 col-span-full">Enter details above and click Generate to see gift ideas!</p>
				</div>
				<!-- Regenerate Suggestions Button -->
				<div class="text-center mt-8">
					<button id="regenerate-btn" type="button" class="hidden bg-[#FF6B6B] hover:bg-[#ff4c4c] text-white font-bold py-3 px-8 rounded-full transition-colors font-poppins text-lg shadow" style="display:none;">
						Regenerate Suggestions
					</button>
				</div>
			</div>
		</section>

		<!-- Featured Gift Guides Grid -->
		<div class="w-full bg-[#FEF2D3] py-16 px-4">
			<section id="featured-guides" class="max-w-5xl mx-auto">
				<h2 class="text-3xl font-bold text-center mb-12 font-poppins text-[#1C2E4A]">Featured Gift Guides</h2>
				<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
					{allContent.length > 0 ? (
						allContent.slice(0, 6).map(item => (
							<article class="bg-[#A3E4DB] rounded-2xl shadow-lg overflow-hidden flex flex-col" tabindex="0" aria-label={`Guide: ${item.data.title}`}> 
								<img src={item.data.image} alt={item.data.title} class="h-40 w-full object-cover rounded-t-xl shadow">
								<div class="p-6 flex-1 flex flex-col">
									<h3 class="font-bold text-lg mb-2 font-poppins text-[#1C2E4A]">{item.data.title}</h3>
									<p class="text-[#333] mb-4 flex-1 font-inter">{item.data.description}</p>
									<a href={`/blog/${item.slug}`} class="mt-auto inline-block bg-[#FF6B6B] hover:bg-[#ff4c4c] text-white font-bold py-2 px-4 rounded-full transition-colors font-poppins shadow" aria-label={`Read ${item.data.title} guide`}>Read Guide</a>
								</div>
							</article>
						))
					) : (
						<article class="bg-[#A3E4DB] rounded-2xl shadow-lg overflow-hidden flex flex-col" tabindex="0" aria-label="Guide: Coming Soon">
							<div class="h-40 w-full bg-[#A3E4DB] flex items-center justify-center text-[#1C2E4A] opacity-60">No guides yet</div>
							<div class="p-6 flex-1 flex flex-col">
								<h3 class="font-bold text-lg mb-2 font-poppins text-[#1C2E4A]">More Gift Guides Coming Soon</h3>
								<p class="text-[#333] mb-4 flex-1 font-inter">Check back soon for curated gift ideas and inspiration!</p>
							</div>
						</article>
					)}
				</div>
				<div class="text-center mt-10">
					<a href="/blog" class="inline-block bg-[#FF6B6B] hover:bg-[#ff4c4c] text-white font-bold py-3 px-8 rounded-full transition-colors font-poppins shadow" aria-label="Browse all gift guides">Browse all gift guides</a>
				</div>
			</section>
		</div>

		<!-- About the Tool / SEO Content Block -->
		<section id="about-tool" class="py-16 px-4 max-w-3xl mx-auto text-center" itemscope itemtype="https://schema.org/WebPage">
			<h2 class="text-2xl font-bold mb-4 font-poppins text-[#1C2E4A]" itemprop="headline">About the AI Gift Idea Generator</h2>
			<p class="text-[#333] mb-6 font-inter" itemprop="description">
				Bright Gift's AI Gift Idea Generator helps you find the perfect present for anyone, instantly. Just enter a few details and our advanced AI suggests unique, thoughtful gifts tailored to your recipient's interests, style, and budget. Save time, discover new ideas, and shop smarterâ€”all in one place.
			</p>
			<a href="#tool" class="inline-block bg-[#FF6B6B] hover:bg-[#ff4c4c] text-white font-bold py-3 px-8 rounded-full transition-colors font-poppins text-lg shadow" aria-label="Try the AI Gift Finder now">
				Try the AI Gift Finder
			</a>
		</section>

	</main>

	<!-- Footer -->
	<footer class="bg-[#1C2E4A] text-white text-sm py-6 mt-16 text-center">
		<div class="flex flex-col items-center gap-2">
			<span class="flex items-center gap-2">
				<img src="/bright-gift-logo.png" alt="" class="h-6 inline" />
				<span>BrightGift &copy; {new Date().getFullYear()}</span>
			</span>
			<span>
				<a href="/about" class="underline hover:no-underline">About</a> &middot;
				<a href="/blog" class="underline hover:no-underline">Blog</a> &middot;
				<a href="/privacy" class="underline hover:no-underline">Privacy</a>
			</span>
			<span class="opacity-70">"Let's Find Something Fun!"</span>
		</div>
	</footer>
</Layout>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const form = document.querySelector('form');
		const resultsContainer = document.getElementById('results-container');
		const loadingIndicator = document.getElementById('loading');
		const styleButtons = document.querySelectorAll('button[type="button"]');
		const regenerateBtn = document.getElementById('regenerate-btn');
		const emptyState = document.getElementById('empty-state');

		let selectedStyle = '';
		let lastInputs = {};

		styleButtons.forEach(button => {
			button.addEventListener('click', () => {
				styleButtons.forEach(btn => {
					btn.classList.remove('bg-blue-600', 'text-white');
					btn.classList.add('bg-gray-200', 'text-gray-700');
				});
				button.classList.add('bg-blue-600', 'text-white');
				button.classList.remove('bg-gray-200', 'text-gray-700');
				selectedStyle = button.innerText;
			});
		});

		form.addEventListener('submit', async (event) => {
			event.preventDefault();
			// Scroll to results section immediately
			document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
			const formData = new FormData(form);
			const recipient = formData.get('recipient');
			const interests = formData.get('interests');
			const budget = formData.get('budget');
			if (!recipient || !interests || !budget) {
				resultsContainer.innerHTML = `<p class="text-red-500 text-center" role="alert">Please fill in all required fields.</p>`;
				return;
			}
			loadingIndicator.classList.remove('hidden');
			resultsContainer.innerHTML = '';

			try {
				const response = await fetch('/api/generate', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ recipient, interests, budget, style: selectedStyle }),
				});
				let errorMsg = 'Failed to get ideas.';
				if (!response.ok) {
					try {
						const err = await response.json();
						errorMsg = err.error || errorMsg;
					} catch {}
					throw new Error(errorMsg);
				}
				const { ideas } = await response.json();
				if (Array.isArray(ideas) && ideas.length) {
					resultsContainer.innerHTML = renderIdeaCards(ideas);
					regenerateBtn.classList.remove('hidden');
					regenerateBtn.style.display = '';
				} else {
					resultsContainer.innerHTML = `<p class="text-red-500 text-center" role="alert">No gift ideas found or failed to parse results. Please try again.</p>`;
					regenerateBtn.classList.add('hidden');
					regenerateBtn.style.display = 'none';
				}
				lastInputs = { recipient, interests, budget, style: selectedStyle };
			} catch (error) {
				resultsContainer.innerHTML = `<p class="text-red-500 text-center" role="alert">${error.message}</p>`;
				regenerateBtn.classList.add('hidden');
				regenerateBtn.style.display = 'none';
			} finally {
				loadingIndicator.classList.add('hidden');
			}
		});

		regenerateBtn.addEventListener('click', async () => {
			if (!lastInputs.recipient) return;
			loadingIndicator.classList.remove('hidden');
			resultsContainer.innerHTML = '';
			try {
				const response = await fetch('/api/generate', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(lastInputs),
				});
				if (!response.ok) throw new Error('Failed to get ideas.');
				const { ideas } = await response.json();
				resultsContainer.innerHTML = renderIdeaCards(ideas);
				regenerateBtn.classList.add('hidden');
				regenerateBtn.style.display = 'none';
			} catch (error) {
				resultsContainer.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
				regenerateBtn.classList.add('hidden');
				regenerateBtn.style.display = 'none';
			} finally {
				loadingIndicator.classList.add('hidden');
			}
		});
	});

	function renderIdeaCards(ideas) {
		const iconSvgMap = {
			DeviceMobile: '/icons/DeviceMobile.svg',
			Book: '/icons/Book.svg',
			TShirt: '/icons/TShirt.svg',
			House: '/icons/House.svg',
			Tree: '/icons/Tree.svg',
			CookingPot: '/icons/CookingPot.svg',
			PuzzlePiece: '/icons/PuzzlePiece.svg',
			Flower: '/icons/Flower.svg',
			SoccerBall: '/icons/SoccerBall.svg',
			PawPrint: '/icons/PawPrint.svg',
			Baby: '/icons/Baby.svg',
			Car: '/icons/Car.svg',
			Briefcase: '/icons/Briefcase.svg',
			MusicNote: '/icons/MusicNote.svg',
			Heartbeat: '/icons/Heartbeat.svg',
			ShoppingBag: '/icons/ShoppingBag.svg',
			BeerBottle: '/icons/BeerBottle.svg',
			Pencil: '/icons/Pencil.svg',
			Package: '/icons/Package.svg',
			Wrench: '/icons/Wrench.svg',
			Smiley: '/icons/Smiley.svg'
		};
		return ideas.map(idea => {
			let iconHtml = '';
			if (idea.icon) {
				const iconPath = iconSvgMap[idea.icon] || iconSvgMap['ShoppingBag'];
				// CSS filter for #1C2E4A (dark blue)
				iconHtml = `<img src="${iconPath}" alt="${idea.icon || 'ShoppingBag'} icon" class="h-20 w-20 mb-6 mt-2" loading="lazy" style="filter: brightness(0) saturate(100%) invert(13%) sepia(22%) saturate(1162%) hue-rotate(176deg) brightness(97%) contrast(98%);" />`;
			}
			return `
				<div class="flex flex-col items-center justify-between bg-[#A3E4DB] rounded-2xl shadow-lg p-8 min-h-[480px] transition-transform hover:-translate-y-1 hover:shadow-2xl animate-fade-in" role="listitem">
					${iconHtml || (idea.image ? `<img src="${idea.image}" alt="${idea.title}" class="h-40 w-full object-cover mb-4 rounded-xl shadow" loading="lazy">` : '')}
					<h3 class="font-bold text-2xl mb-3 font-poppins text-[#1C2E4A] text-center">${idea.title}</h3>
					<p class="text-[#333] mb-4 font-inter text-base text-center line-clamp-4">${idea.description}</p>
					${idea.tag ? `<span class="inline-block bg-[#FFDE59] text-[#1C2E4A] text-xs font-semibold px-4 py-1 rounded-full mb-6 mt-auto">${idea.tag}</span>` : ''}
					<a href="${idea.link}" target="_blank" rel="nofollow noopener" class="w-full bg-[#FF6B6B] hover:bg-[#ff4c4c] text-white font-bold py-3 rounded-full transition-colors font-poppins text-lg shadow text-center" aria-label="View ${idea.title} (affiliate link)">
						Find on ${/etsy/i.test(idea.link) ? 'Etsy' : 'Amazon'}
					</a>
				</div>
			`;
		}).join('');
	}

	const style = document.createElement('style');
	style.innerHTML = `
		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(10px); }
			to { opacity: 1; transform: translateY(0); }
		}
		.animate-fade-in {
			animation: fadeIn 0.5s ease-out forwards;
		}
	`;
	document.head.appendChild(style);
</script> 